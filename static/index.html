<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ERP Document AI</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'Segoe UI', sans-serif;
    background: #f0f4f8;
    height: 100vh;
    display: flex;
    flex-direction: column;
  }

  /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
  .header {
    background: #1a73e8;
    color: white;
    padding: 16px 24px;
    display: flex;
    align-items: center;
    gap: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  }
  .header-icon { font-size: 24px; }
  .header h1 { font-size: 18px; font-weight: 600; }
  .header p { font-size: 12px; opacity: 0.8; }

  /* ‚îÄ‚îÄ Main Layout ‚îÄ‚îÄ */
  .main {
    display: flex;
    flex: 1;
    overflow: hidden;
  }

  /* ‚îÄ‚îÄ Sidebar ‚îÄ‚îÄ */
  .sidebar {
    width: 280px;
    background: white;
    border-right: 1px solid #e0e0e0;
    display: flex;
    flex-direction: column;
    padding: 16px;
    gap: 12px;
  }
  .sidebar h3 {
    font-size: 13px;
    color: #888;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 4px;
  }

  /* Upload Area */
  .upload-area {
    border: 2px dashed #c5d5f5;
    border-radius: 10px;
    padding: 20px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    background: #f8faff;
  }
  .upload-area:hover { border-color: #1a73e8; background: #eef3ff; }
  .upload-area .upload-icon { font-size: 28px; margin-bottom: 8px; }
  .upload-area p { font-size: 13px; color: #666; }
  .upload-area span { font-size: 11px; color: #999; }
  #fileInput { display: none; }

  /* Upload Progress */
  .upload-status {
    font-size: 12px;
    padding: 8px 12px;
    border-radius: 8px;
    display: none;
  }
  .upload-status.loading { background: #fff3cd; color: #856404; display: block; }
  .upload-status.success { background: #d1e7dd; color: #0f5132; display: block; }
  .upload-status.error { background: #f8d7da; color: #842029; display: block; }

  /* File List */
  .file-list { display: flex; flex-direction: column; gap: 6px; flex: 1; overflow-y: auto; }
  .file-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 12px;
    border-radius: 8px;
    cursor: pointer;
    border: 2px solid transparent;
    transition: all 0.2s;
    background: #f8f9fa;
  }
  .file-item:hover { background: #eef3ff; border-color: #c5d5f5; }
  .file-item.active { background: #eef3ff; border-color: #1a73e8; }
  .file-item .file-icon { font-size: 20px; }
  .file-item .file-name { font-size: 13px; color: #333; font-weight: 500; word-break: break-all; }
  .file-item .file-type { font-size: 11px; color: #999; }

  .no-files { font-size: 13px; color: #aaa; text-align: center; padding: 20px 0; }

  /* ‚îÄ‚îÄ Chat Area ‚îÄ‚îÄ */
  .chat-area {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  /* Selected file bar */
  .selected-bar {
    background: #eef3ff;
    border-bottom: 1px solid #c5d5f5;
    padding: 10px 20px;
    font-size: 13px;
    color: #1a73e8;
    display: none;
    align-items: center;
    gap: 8px;
  }
  .selected-bar.visible { display: flex; }

  /* Messages */
  .messages {
    flex: 1;
    overflow-y: auto;
    padding: 24px;
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .welcome {
    text-align: center;
    padding: 60px 20px;
    color: #aaa;
  }
  .welcome .welcome-icon { font-size: 48px; margin-bottom: 16px; }
  .welcome h2 { font-size: 18px; color: #666; margin-bottom: 8px; }
  .welcome p { font-size: 14px; }

  .message { display: flex; gap: 12px; max-width: 80%; }
  .message.user { align-self: flex-end; flex-direction: row-reverse; }
  .message.bot { align-self: flex-start; }

  .avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    flex-shrink: 0;
  }
  .message.user .avatar { background: #1a73e8; color: white; font-size: 14px; font-weight: 600; }
  .message.bot .avatar { background: #f0f4f8; }

  .bubble {
    padding: 12px 16px;
    border-radius: 16px;
    font-size: 14px;
    line-height: 1.6;
  }
  .message.user .bubble {
    background: #1a73e8;
    color: white;
    border-top-right-radius: 4px;
  }
  .message.bot .bubble {
    background: white;
    color: #333;
    border-top-left-radius: 4px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.08);
  }

  /* Typing indicator */
  .typing .bubble { padding: 16px; }
  .typing-dots { display: flex; gap: 4px; }
  .typing-dots span {
    width: 8px; height: 8px;
    background: #1a73e8;
    border-radius: 50%;
    animation: bounce 1.2s infinite;
  }
  .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
  .typing-dots span:nth-child(3) { animation-delay: 0.4s; }
  @keyframes bounce {
    0%, 80%, 100% { transform: translateY(0); }
    40% { transform: translateY(-8px); }
  }

  /* ‚îÄ‚îÄ Input Area ‚îÄ‚îÄ */
  .input-area {
    padding: 16px 24px;
    background: white;
    border-top: 1px solid #e0e0e0;
    display: flex;
    gap: 12px;
    align-items: center;
  }
  .input-area input {
    flex: 1;
    padding: 12px 16px;
    border: 2px solid #e0e0e0;
    border-radius: 24px;
    font-size: 14px;
    outline: none;
    transition: border-color 0.2s;
  }
  .input-area input:focus { border-color: #1a73e8; }
  .input-area input:disabled { background: #f5f5f5; cursor: not-allowed; }
  .send-btn {
    width: 44px; height: 44px;
    background: #1a73e8;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    color: white;
    font-size: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s;
  }
  .send-btn:hover { background: #1557b0; }
  .send-btn:disabled { background: #ccc; cursor: not-allowed; }
</style>
</head>
<body>

<!-- Header -->
<div class="header">
  <div class="header-icon">ü§ñ</div>
  <div>
    <h1>ERP Document AI</h1>
    <p>Ask questions about your documents ‚Äî Powered by RAG + Ollama</p>
  </div>
</div>

<div class="main">

  <!-- Sidebar -->
  <div class="sidebar">
    <h3>Documents</h3>

    <!-- Upload Area -->
    <div class="upload-area" onclick="document.getElementById('fileInput').click()">
      <div class="upload-icon">üìÅ</div>
      <p>Click to upload file</p>
      <span>PDF, Excel, Word, CSV</span>
    </div>
    <input type="file" id="fileInput" accept=".pdf,.xlsx,.xls,.csv,.docx,.doc" onchange="uploadFile(this)">

    <!-- Upload Status -->
    <div class="upload-status" id="uploadStatus"></div>

    <!-- File List -->
    <h3>Uploaded Files</h3>
    <div class="file-list" id="fileList">
      <div class="no-files">No files uploaded yet</div>
    </div>
  </div>

  <!-- Chat Area -->
  <div class="chat-area">

    <!-- Selected File Bar -->
    <div class="selected-bar" id="selectedBar">
      <span>üìÑ</span>
      <span id="selectedFileName">No file selected</span>
    </div>

    <!-- Messages -->
    <div class="messages" id="messages">
      <div class="welcome">
        <div class="welcome-icon">üìÇ</div>
        <h2>Upload a document to get started</h2>
        <p>Upload a PDF, Excel, Word or CSV file from the sidebar,<br>then ask any question about it.</p>
      </div>
    </div>

    <!-- Input -->
    <div class="input-area">
      <input type="text" id="messageInput" placeholder="Select a file first, then ask a question..." disabled onkeydown="if(event.key==='Enter') sendMessage()">
      <button class="send-btn" id="sendBtn" onclick="sendMessage()" disabled>‚û§</button>
    </div>
  </div>
</div>

<script>
  let selectedFile = null;

  // ‚îÄ‚îÄ File Icon based on extension ‚îÄ‚îÄ
  function getFileIcon(filename) {
    const ext = filename.split('.').pop().toLowerCase();
    if (ext === 'pdf') return 'üìï';
    if (['xlsx', 'xls', 'csv'].includes(ext)) return 'üìó';
    if (['docx', 'doc'].includes(ext)) return 'üìò';
    return 'üìÑ';
  }

  // ‚îÄ‚îÄ Load existing files ‚îÄ‚îÄ
  async function loadFiles() {
    const res = await fetch('/files');
    const data = await res.json();
    renderFiles(data.files || []);
  }

  function renderFiles(files) {
    const list = document.getElementById('fileList');
    if (files.length === 0) {
      list.innerHTML = '<div class="no-files">No files uploaded yet</div>';
      return;
    }
    list.innerHTML = files.map(f => `
      <div class="file-item ${selectedFile === f ? 'active' : ''}" onclick="selectFile('${f}')">
        <span class="file-icon">${getFileIcon(f)}</span>
        <div>
          <div class="file-name">${f}</div>
          <div class="file-type">${f.split('.').pop().toUpperCase()}</div>
        </div>
      </div>
    `).join('');
  }

  // ‚îÄ‚îÄ Select File ‚îÄ‚îÄ
  function selectFile(fileName) {
    selectedFile = fileName;
    document.getElementById('selectedBar').classList.add('visible');
    document.getElementById('selectedFileName').textContent = fileName;
    document.getElementById('messageInput').disabled = false;
    document.getElementById('messageInput').placeholder = `Ask a question about ${fileName}...`;
    document.getElementById('sendBtn').disabled = false;
    document.getElementById('messageInput').focus();
    loadFiles(); // re-render to update active state

    // Clear messages and show welcome for this file
    document.getElementById('messages').innerHTML = `
      <div class="welcome">
        <div class="welcome-icon">${getFileIcon(fileName)}</div>
        <h2>${fileName}</h2>
        <p>File is ready! Ask any question about this document.</p>
      </div>
    `;
  }

  // ‚îÄ‚îÄ Upload File ‚îÄ‚îÄ
  async function uploadFile(input) {
    const file = input.files[0];
    if (!file) return;

    const status = document.getElementById('uploadStatus');
    status.className = 'upload-status loading';
    status.textContent = `‚è≥ Uploading and indexing "${file.name}"... Please wait.`;

    const formData = new FormData();
    formData.append('file', file);

    try {
      const res = await fetch('/upload', { method: 'POST', body: formData });
      const data = await res.json();
      if (data.success) {
        status.className = 'upload-status success';
        status.textContent = `‚úÖ ${data.message}`;
        loadFiles();
        setTimeout(() => { status.style.display = 'none'; }, 4000);
      } else {
        status.className = 'upload-status error';
        status.textContent = `‚ùå ${data.error}`;
      }
    } catch (e) {
      status.className = 'upload-status error';
      status.textContent = `‚ùå Upload failed: ${e.message}`;
    }

    input.value = '';
  }

  // ‚îÄ‚îÄ Add Message to Chat ‚îÄ‚îÄ
  function addMessage(text, role) {
    const messages = document.getElementById('messages');

    // Remove welcome screen on first message
    const welcome = messages.querySelector('.welcome');
    if (welcome) welcome.remove();

    const div = document.createElement('div');
    div.className = `message ${role}`;
    div.innerHTML = `
      <div class="avatar">${role === 'user' ? 'You' : 'ü§ñ'}</div>
      <div class="bubble">${text.replace(/\n/g, '<br>')}</div>
    `;
    messages.appendChild(div);
    messages.scrollTop = messages.scrollHeight;
    return div;
  }

  // ‚îÄ‚îÄ Typing Indicator ‚îÄ‚îÄ
  function addTyping() {
    const messages = document.getElementById('messages');
    const div = document.createElement('div');
    div.className = 'message bot typing';
    div.id = 'typing';
    div.innerHTML = `
      <div class="avatar">ü§ñ</div>
      <div class="bubble">
        <div class="typing-dots">
          <span></span><span></span><span></span>
        </div>
      </div>
    `;
    messages.appendChild(div);
    messages.scrollTop = messages.scrollHeight;
  }

  function removeTyping() {
    const t = document.getElementById('typing');
    if (t) t.remove();
  }

  // ‚îÄ‚îÄ Send Message ‚îÄ‚îÄ
  async function sendMessage() {
    const input = document.getElementById('messageInput');
    const message = input.value.trim();
    if (!message || !selectedFile) return;

    input.value = '';
    document.getElementById('sendBtn').disabled = true;

    addMessage(message, 'user');
    addTyping();

    try {
      const res = await fetch('/query', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ message, file_name: selectedFile })
      });
      const data = await res.json();
      removeTyping();
      if (data.answer) {
        addMessage(data.answer, 'bot');
      } else {
        addMessage(`‚ùå ${data.error || 'Something went wrong.'}`, 'bot');
      }
    } catch (e) {
      removeTyping();
      addMessage(`‚ùå Error: ${e.message}`, 'bot');
    }

    document.getElementById('sendBtn').disabled = false;
    input.focus();
  }

  // Load files on page load
  loadFiles();
</script>
</body>
</html>
